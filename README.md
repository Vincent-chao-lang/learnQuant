# BTC 量化分析系统说明文档

> 一个完整的比特币量化分析流水线：数据获取 → 量化分析 → 报告生成 → 邮件发送

---

# 第一部分：系统价值说明

## 一、这份报告要解决什么问题？

### 常见的投资困境

| 投资者的真实状态 | 问题 |
|-----------------|------|
| 看到涨了，想追 | 现在是不是太晚了？ |
| 看到跌了，慌了 | 会继续跌吗？该止损吗？ |
| 连续赚钱，飘了 | 是自己厉害还是环境好？ |
| 连续亏钱，怀疑 | 市场在针对我吗？ |

**根本矛盾**：你不知道"当前市场环境"是否友好，只能凭感觉和情绪做决定。

---

## 二、这份报告的本质

```
它不是一张"藏宝图"
它是一张"地形图"
```

- **藏宝图**：告诉你哪里有宝藏（预测价格）
- **地形图**：告诉你哪里是悬崖、哪里是平地（风险分布）

**不做方向预测，只做风险描述**：
- ❌ 不会说：明天会涨到 $X
- ✅ 会说：在类似历史环境下，未来 10 天的收益分布是这样的（左边亏损多，还是右边盈利多）

---

## 三、与常见分析的区别

| 常见分析 | 这份报告 |
|---------|---------|
| 关注"会涨还是会跌" | 关注"在各种可能结果中，不利结果有多糟糕" |
| 给你一个数字（目标价） | 给你一个分布（范围+概率） |
| 让你知道"怎么赢" | 让你知道"什么时候不该冒险" |
| 容易让人过度自信 | 帮助你保持敬畏 |
| 单点思维 | 分布思维 |

---

## 四、三个核心价值

### 价值 1：区分"运气"与"环境"

```
你赚钱了
    ↓
是你厉害？还是市场环境本来就好？
    ↓
这份报告告诉你：当前属于哪种"市场状态"
    ↓
历史数据显示：这种状态通常是"友好的"还是"不友好的"
```

**实际意义**：在友好环境里可以更积极，在不友好环境里需要更谨慎。

---

### 价值 2：左尾风险可视化

报告重点展示的**不是平均收益**，而是：

| 指标 | 含义 | 为什么重要 |
|------|------|-----------|
| **p10** | 最差的 10% 情况下的平均亏损 | 常态化的"坏情况"有多坏 |
| **min** | 历史上最极端的一次亏损 | 极端情况可能发生什么 |
| **胜率** | 盈利天数占比 | 总体上盈利概率如何 |

**实际意义**：你无法承受的损失，比平均收益更值得关心。

---

### 价值 3：相似历史的统计参考

当市场出现一段走势，报告会：

1. 在历史中找到最相似的若干段片段
2. 统计这些片段"接下来"发生了什么
3. 画出分布直方图

**这不是预测**，而是告诉你：

> "历史上，当市场长成这样的时候，后来通常是这样的分布"

**实际意义**：用历史经验校准你的预期，而不是凭空想象。

---

## 五、如何正确使用这份报告

### ✅ 正确使用

```
1. 看当前状态是否 = "最容易亏钱的状态"
   → 是：降低风险暴露，减少操作频率
   → 否：保持正常节奏

2. 看相似行情的未来分布直方图
   → 左边（亏损）很多：谨慎
   → 中间或右边居多：风险相对可控

3. 任何决策前问自己：
   "如果我是历史上最差的 10% 结果，我接受吗？"
```

### ❌ 错误使用

- 把它当预测工具
- 只看平均收益，忽略风险
- 发现"有利"就盲目加仓
- 用单次结果否定统计结论

---

## 六、报告的局限性

```
任何统计规律都有例外，市场永远可能走出"未曾见过"的形态
```

1. **历史不会重复，只是押韵**：相似不代表相同
2. **分布只是概率**：单次结果可能偏离分布很远
3. **黑天鹅无法预测**：极端事件可能超出历史样本

**正确的态度**：

> 这份报告的价值，不在于它有多聪明，
> 而在于它能不能让你少犯明显的错误。

---

## 七、一句话总结

```
这份报告不是帮你"赢"的工具
而是帮你"不输在起跑线上"的检查表
```

它在回答一个问题：

> **"当前这个环境，值得我冒险吗？"**

而不是：

> "明天会涨吗？"

---

# 第二部分：技术实现说明

## 一、系统概述

这是一个比特币（BTC）量化分析入门脚本，实现了一个完整的数据分析流水线。

**核心设计理念**：不做价格方向预测，而是通过统计分析理解市场结构和风险分布。

---

## 二、主要功能模块

### 1. 数据获取与更新

**数据源策略**：主源 + 备源双保险

| 数据源 | 类型 | 用途 |
|--------|------|------|
| Stooq | 主源 | 全量日线数据，稳定可靠 |
| CoinGecko | 备源 | 增量补充（最近2天），带重试机制 |

**核心函数**：
- `fetch_btcusd_daily_from_stooq()` - 从 Stooq 获取日线数据
- `fetch_btcusd_daily_increment_from_coingecko()` - 从 CoinGecko 获取增量数据
- `safe_fetch_btcusd_increment_from_coingecko()` - 带指数退避重试（3次）
- `update_price_csv()` - 智能合并更新本地 CSV

**数据标准化**：统一输出 `date, price_usd` 两列格式

---

### 2. 量化分析

**特征工程**（`load_and_features`）：

| 特征 | 说明 |
|------|------|
| `log_price` | 对数价格 |
| `ret` | 日对数收益率 |
| `vol_7d` | 7日滚动波动率 |
| `vol_30d` | 30日滚动波动率 |
| `trend_30d` | 30日趋势指标 |

**三大分析模块**：

1. **基本统计** (`basic_summary`)：收益率均值、胜率、年化波动等

2. **市场状态聚类** (`cluster_market_states`)：
   - 使用 K-Means 将市场分为 k=6 种状态
   - 基于收益、波动、趋势特征分类

3. **相似行情匹配** (`similar_windows_future_dist`)：
   - 使用余弦相似度寻找历史相似片段
   - 统计相似行情后的未来收益分布
   - 生成直方图可视化

4. **风险识别** (`risk_by_state`)：
   - 按状态统计未来收益分布
   - 识别"最容易亏钱的状态"

---

### 3. 报告生成

**输出内容**：

```markdown
# BTC 量化分析入门版报告

## 阅读指南
## 市场基本画像
## 市场状态（当前状态编号）
## 风险识别（各状态收益分布）
## 相似行情 → 未来分布
## 结论提醒
## 附录：术语白话解释
```

**文件输出**：
- `report.md` - 稳定命名（覆盖更新）
- `report_YYYY-MM-DD.md` - 带日期归档
- `future_hist_YYYY-MM-DD.png` - 收益分布直方图

---

### 4. 邮件发送

**邮件格式**：
- HTML 正文（带表格样式）
- 纯文本 fallback
- 直方图内嵌（CID 引用）
- 可选附件（MD/HTML/PDF）

**发送方式**：
```
email_report_as_body()
├── 将报告内容作为邮件正文
├── 内嵌图片（不显示为附件）
└── 可选备份附件
```

---

## 三、配置要求

### 环境变量（`.env` 文件）

```bash
SMTP_USER=your@gmail.com
SMTP_PASS=your_app_password
TO_EMAIL=recipient@example.com
```

### 依赖包

```bash
pip install numpy pandas scikit-learn matplotlib requests python-dotenv
brew install pandoc  # 可选，用于 PDF 生成
```

---

## 四、CLI 参数

| 参数 | 默认值 | 说明 |
|------|--------|------|
| `--csv` | `./bitcoin_price_history_usd.csv` | 本地数据路径 |
| `--out-dir` | `./reports` | 输出目录 |
| `--k` | 6 | 状态聚类数量 |
| `--window` | 20 | 相似窗口长度（天） |
| `--topk` | 12 | 最相似窗口数量 |
| `--horizon` | 10 | 未来统计窗口（天） |
| `--no-email` | - | 只生成报告不发邮件 |
| `--no-update` | - | 跳过数据更新 |

---

## 五、典型使用场景

```bash
# 完整流程
python btc_quant_intro_analysis.py

# 只生成报告，不发邮件
python btc_quant_intro_analysis.py --no-email

# 调试模式：不更新数据
python btc_quant_intro_analysis.py --no-update --no-email

# 自定义参数
python btc_quant_intro_analysis.py --k 8 --window 30 --horizon 20
```

---

## 六、文件结构图

```
btc_quant_intro_analysis.py
│
├── 工具函数
│   ├── df_to_md_table()      # DataFrame 转 Markdown 表格
│   └── ensure_dir()          # 目录创建
│
├── 数据层
│   ├── fetch_btcusd_daily_from_stooq()
│   ├── fetch_btcusd_daily_increment_from_coingecko()
│   └── update_price_csv()
│
├── 分析层
│   ├── load_and_features()              # 特征工程
│   ├── cluster_market_states()          # 状态聚类
│   ├── similar_windows_future_dist()    # 相似行情
│   └── risk_by_state()                  # 风险识别
│
├── 报告层
│   ├── generate_report()        # 主报告生成
│   └── glossary_section()       # 术语附录
│
└── 发送层
    ├── md_to_html_email()               # Markdown 转 HTML
    ├── send_email_gmail_inline_report() # 邮件发送
    └── email_report_as_body()           # 整体流程
```

---

# 附录

## 报告中的关键指标速查

| 指标 | 一句话解释 |
|------|-----------|
| 当前状态编号 | 市场现在的"环境类型"，k=6 表示分为 6 类 |
| 最容易亏钱的状态 | 历史上综合风险最高的状态编号 |
| p10 / min | 左尾风险，最差情况的亏损水平 |
| 胜率 | 收益为正的天数占比 |
| 未来收益分布直方图 | 相似行情下未来可能的涨跌范围 |

---

## 核心设计特点

1. **容错性强**：主备数据源自动切换，带重试机制
2. **不预测，只描述**：报告强调分布而非单点预测
3. **风险导向**：重点关注 p10/min（左尾风险）和胜率
4. **用户友好**：报告附带术语白话解释附录
5. **渐进式归档**：图片按日期命名，不覆盖历史
